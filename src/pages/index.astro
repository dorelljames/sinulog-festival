---
import Layout from "../layouts/Layout.astro";
import * as scheduleData from "../data.json";
import { GOOGLE_MAPS_API_KEY } from "../config";
import { venueCoordinates } from "../data/locations";

const sortedSchedule = scheduleData.schedule.sort(
  (a, b) => new Date(a.date).getTime() - new Date(b.date).getTime()
);

// Filter out multi-day events
const dailySchedule = sortedSchedule.filter((day) => !day.endDate);
const multiDayEvents = sortedSchedule.filter((day) => day.endDate);

// Get today's date in YYYY-MM-DD format
const today = new Date().toISOString().split("T")[0];

// Find the closest date to today
const defaultDate = dailySchedule
  .map((day) => day.date)
  .reduce((prev, curr) =>
    Math.abs(new Date(curr).getTime() - new Date(today).getTime()) <
    Math.abs(new Date(prev).getTime() - new Date(today).getTime())
      ? curr
      : prev
  );

// Get unique venues for map markers
const venues = [
  ...new Set(
    sortedSchedule.flatMap((day) =>
      day.events
        .filter(
          (event) =>
            event.venue &&
            event.venue !== "To be announced" &&
            event.venue !== "TBA"
        )
        .map((event) => ({
          name: event.venue,
          events: [{ ...event, date: day.date }],
        }))
    )
  ),
].reduce((acc, curr) => {
  const existing = acc.find((v) => v.name === curr.name);
  if (existing) {
    existing.events.push(...curr.events);
    return acc;
  }
  return [...acc, curr];
}, []);

// Serialize venues data for client-side use
const serializedVenues = JSON.stringify(venues);
const serializedVenueCoordinates = JSON.stringify(venueCoordinates);
const serializedDefaultDate = JSON.stringify(defaultDate);
---

<Layout>
  <main class="min-h-screen flex">
    {/* Sidebar */}
    <aside
      class="w-96 bg-white shadow-lg overflow-y-auto h-screen sticky top-0"
    >
      <div class="p-4">
        <header class="mb-6">
          <h1 class="text-2xl font-bold text-orange-600">
            {scheduleData.festivalName}
          </h1>
          <p class="text-sm text-gray-600">{scheduleData.tagline}</p>
        </header>

        {/* Date Navigation */}
        <div class="mb-6 flex gap-2 overflow-x-auto pb-2">
          {
            dailySchedule.map((day) => (
              <button
                class={`px-3 py-1 text-sm rounded-full transition-colors whitespace-nowrap ${
                  day.date === defaultDate
                    ? "bg-orange-500 text-white"
                    : "bg-orange-100 hover:bg-orange-200 text-orange-900"
                }`}
                onclick={`scrollToDay('${day.date}')`}
              >
                {new Date(day.date).toLocaleDateString("en-US", {
                  month: "short",
                  day: "numeric",
                })}
              </button>
            ))
          }
        </div>

        {/* Daily Events */}
        <div class="space-y-8">
          {
            dailySchedule.map((day) => (
              <div
                id={day.date}
                class={`scroll-mt-4 ${
                  day.date !== defaultDate ? "hidden" : ""
                }`}
              >
                <h2 class="text-lg font-semibold text-orange-800 mb-3">
                  {new Date(day.date).toLocaleDateString("en-US", {
                    weekday: "long",
                    month: "long",
                    day: "numeric",
                  })}
                </h2>
                <div class="space-y-3">
                  {day.events.map((event) => (
                    <button
                      class="w-full text-left p-3 rounded-lg hover:bg-orange-50 transition-colors"
                      onclick={`centerMapOnVenue('${event.venue}')`}
                      disabled={
                        !event.venue ||
                        event.venue === "To be announced" ||
                        event.venue === "TBA"
                      }
                    >
                      <p class="font-medium text-gray-900">{event.name}</p>
                      <div class="text-sm text-gray-600 mt-1">
                        {event.time && <span>üïí {event.time}</span>}
                        {event.venue && (
                          <span class="ml-2">üìç {event.venue}</span>
                        )}
                      </div>
                    </button>
                  ))}
                </div>
              </div>
            ))
          }
        </div>
      </div>
    </aside>

    {/* Map Container */}
    <div class="flex-1">
      <div id="map" class="w-full h-screen"></div>
    </div>
  </main>

  <script
    define:vars={{
      serializedVenues,
      serializedVenueCoordinates,
      serializedDefaultDate,
    }}
  >
    const cebuLatLng = { lat: 10.3157, lng: 123.8854 }; // Cebu City center
    const venuesData = JSON.parse(serializedVenues);
    const venueCoordinates = JSON.parse(serializedVenueCoordinates);
    const defaultDate = JSON.parse(serializedDefaultDate);
    let map;
    let markers = {};
    let activeInfoWindow = null;

    function initMap() {
      map = new google.maps.Map(document.getElementById("map"), {
        zoom: 13,
        center: cebuLatLng,
        styles: [
          {
            featureType: "poi",
            elementType: "labels",
            stylers: [{ visibility: "off" }],
          },
        ],
      });

      // Add custom marker icons
      const markerIcons = {
        default: "https://maps.google.com/mapfiles/ms/icons/red-dot.png",
        active: "https://maps.google.com/mapfiles/ms/icons/orange-dot.png",
      };

      // Create markers for each venue
      venuesData.forEach((venue) => {
        const coordinates = venueCoordinates[venue.name];
        if (!coordinates) return;

        // Check if venue has events on the default date
        const hasEventsToday = venue.events.some(
          (event) => event.date === defaultDate
        );

        const marker = new google.maps.Marker({
          position: coordinates,
          map: map,
          title: venue.name,
          icon: hasEventsToday ? markerIcons.active : markerIcons.default,
          animation: hasEventsToday ? google.maps.Animation.DROP : null,
        });

        const infoWindow = new google.maps.InfoWindow({
          content: createInfoWindowContent(venue),
        });

        marker.addListener("click", () => {
          if (activeInfoWindow) {
            activeInfoWindow.close();
          }
          infoWindow.open(map, marker);
          activeInfoWindow = infoWindow;
        });

        markers[venue.name] = marker;
      });

      // Fit map to show all markers
      const bounds = new google.maps.LatLngBounds();
      Object.values(markers).forEach((marker) => {
        bounds.extend(marker.getPosition());
      });
      map.fitBounds(bounds);
    }

    function centerMapOnVenue(venueName) {
      const marker = markers[venueName];
      if (marker) {
        map.panTo(marker.getPosition());
        map.setZoom(15);
        google.maps.event.trigger(marker, "click");
      }
    }

    function createInfoWindowContent(venue) {
      return `
        <div class="p-2">
          <h3 class="font-medium text-lg mb-2">${venue.name}</h3>
          <div class="space-y-2">
            ${venue.events
              .map(
                (event) => `
              <div>
                <p class="font-medium">${event.name}</p>
                <p class="text-sm text-gray-600">
                  ${new Date(event.date).toLocaleDateString("en-US", {
                    month: "short",
                    day: "numeric",
                  })}
                  ${event.time ? ` ‚Ä¢ ${event.time}` : ""}
                </p>
              </div>
            `
              )
              .join("")}
          </div>
        </div>
      `;
    }

    function scrollToDay(date) {
      // Hide all date sections
      document.querySelectorAll('[id^="2025-"]').forEach((el) => {
        el.classList.add("hidden");
      });
      // Show selected date section
      const element = document.getElementById(date);
      if (element) {
        element.classList.remove("hidden");
        element.scrollIntoView({ behavior: "smooth" });
      }

      // Update markers
      venuesData.forEach((venue) => {
        const marker = markers[venue.name];
        if (marker) {
          const hasEventsOnDate = venue.events.some(
            (event) => event.date === date
          );
          marker.setIcon(
            hasEventsOnDate ? markerIcons.active : markerIcons.default
          );
          marker.setAnimation(
            hasEventsOnDate ? google.maps.Animation.BOUNCE : null
          );
          setTimeout(() => marker.setAnimation(null), 750);
        }
      });
    }

    // Initialize map after the script loads
    window.initMap = initMap;
    window.centerMapOnVenue = centerMapOnVenue;
    window.scrollToDay = scrollToDay;
  </script>

  <script
    src={`https://maps.googleapis.com/maps/api/js?key=${GOOGLE_MAPS_API_KEY}&callback=initMap&loading=async`}
    defer></script>
</Layout>
